services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: intranet-backend
    restart: unless-stopped
    environment:
      - DATABASE_URL=sqlite:///./data/intranet.db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-change-this-secret-key-in-production}
      - CORS_ORIGINS=${CORS_ORIGINS:-https://intranet.julis-sh.de}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - SMTP_ENABLED=${SMTP_ENABLED:-false}
      - SMTP_HOST=${SMTP_HOST:-smtp.office365.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL:-}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-JuLis SH Intranet}
      - APP_URL=${APP_URL:-https://intranet.julis-sh.de}
      - DOCUMENT_AMENDMENT_NOTIFY_EMAILS=${DOCUMENT_AMENDMENT_NOTIFY_EMAILS:-}
      - MS_TENANT_ID=${MS_TENANT_ID:-}
      - MS_CLIENT_ID=${MS_CLIENT_ID:-}
      - MS_CLIENT_SECRET=${MS_CLIENT_SECRET:-}
      - MS_SENDER_MAIL=${MS_SENDER_MAIL:-}
      - MS_OAUTH_REDIRECT_URI=${MS_OAUTH_REDIRECT_URI:-}
      - PUBLIC_SUBMITTER_USER_ID=${PUBLIC_SUBMITTER_USER_ID:-}
      - PUBLIC_DEFAULT_TENANT_ID=${PUBLIC_DEFAULT_TENANT_ID:-}
    volumes:
      - prod-data:/app/data
    networks:
      - intranet-shared
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=https://intranet.julis-sh.de/api/v1
        - NEXT_PUBLIC_APP_URL=https://intranet.julis-sh.de
        - NEXT_PUBLIC_APP_ENV=production
    container_name: intranet-frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - intranet-shared

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: intranet-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - certbot-conf:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    depends_on:
      - frontend
      - backend
    networks:
      - intranet-shared

# Netzwerk vor dem ersten Start anlegen: docker network create intranet-shared
networks:
  intranet-shared:
    external: true

volumes:
  prod-data:
  certbot-conf:
  certbot-www:
